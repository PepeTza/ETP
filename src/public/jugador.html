<!DOCTYPE html>

<script>

    ws = new WebSocket("ws://localhost:1234");

    let user;
    let botones = [];
    let botonesUsados = [];
    let palabra;
    let palabraO;
    let inicio = false;
    let general = [];
    let vidas = 6;
    
    ws.addEventListener('open', (data) => {

        botones = [q, w, e, r, t, y, u, botonI, o, p,     
                a, s, d, f, g, h, j, k, l, 
                z, x, c, v, b, n, m];

        submit.onclick = () => {    //Envia el nombre de usuario al servidor

            if(username.value.length<2){    //Verifica si el nombre tiene mas de dos caracteres

                window.alert("El nombre de usuario debe contener por lo menos dos caracteres");
            }
            else if (username.value.indexOf(" ")==-1){  //Verifica si el nombre tiene espacios

                user = username.value;
                ws.send(user);
                submit.disabled = true;
                username.disabled = true; 
            }
            else{       //Avisa al jugador que el nombre tiene espacios

                window.alert('El nombre de usuario no puede contener espacios');
            }
        }

        q.onclick = () => {                                                 //Estas funciones envian el valor de su letra y bloquean los botones para fingir que termino su turno

            ws.send(q.value + ` ${user}`);
            botonesUsados.push(q);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        w.onclick = () => {

            ws.send(w.value + ` ${user}`);
            botonesUsados.push(w);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        e.onclick = () => {

            ws.send(e.value + ` ${user}`);
            botonesUsados.push(e);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        r.onclick = () => {

            ws.send(r.value + ` ${user}`);
            botonesUsados.push(r);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        t.onclick = () => {

            ws.send(t.value + ` ${user}`);
            botonesUsados.push(t);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        y.onclick = () => {

            ws.send(y.value + ` ${user}`);
            botonesUsados.push(y);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        u.onclick = () => {

            ws.send(u.value + ` ${user}`);
            botonesUsados.push(u);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        botonI.onclick = () => {

            ws.send(`i ${user}`);
            botonesUsados.push(botonI);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        o.onclick = () => {

            ws.send(o.value + ` ${user}`);
            botonesUsados.push(o);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        p.onclick = () => {

            ws.send(p.value + ` ${user}`);
            botonesUsados.push(p);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        a.onclick = () => {

            ws.send(a.value + ` ${user}`);
            botonesUsados.push(a);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        s.onclick = () => {

            ws.send(s.value + ` ${user}`);
            botonesUsados.push(s);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        d.onclick = () => {

            ws.send(d.value + ` ${user}`);
            botonesUsados.push(d);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        f.onclick = () => {

            ws.send(f.value + ` ${user}`);
            botonesUsados.push(f);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        g.onclick = () => {

            ws.send(g.value + ` ${user}`);
            botonesUsados.push(g);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        h.onclick = () => {

            ws.send(h.value + ` ${user}`);
            botonesUsados.push(h);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        j.onclick = () => {

            ws.send(j.value + ` ${user}`);
            botonesUsados.push(j);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        k.onclick = () => {

            ws.send(k.value + ` ${user}`);
            botonesUsados.push(k);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        l.onclick = () => {

            ws.send(l.value + ` ${user}`);
            botonesUsados.push(l);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        z.onclick = () => {

            ws.send(z.value + ` ${user}`);
            botonesUsados.push(z);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        x.onclick = () => {

            ws.send(x.value + ` ${user}`);
            botonesUsados.push(x);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        c.onclick = () => {

            ws.send(c.value + ` ${user}`);
            botonesUsados.push(c);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        v.onclick = () => {

            ws.send(v.value + ` ${user}`);
            botonesUsados.push(v);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        b.onclick = () => {

            ws.send(b.value + ` ${user}`);
            botonesUsados.push(b);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        n.onclick = () => {

            ws.send(n.value + ` ${user}`);
            botonesUsados.push(n);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }
        m.onclick = () => {

            ws.send(m.value + ` ${user}`);
            botonesUsados.push(m);
            for (i=0; i<botones.length; i++) botones[i].disabled = true;
        }

        ws.addEventListener('message', (data) => {      

            if((data.data+"")[0]=="0"){     //Si va bien el registro llega aqui y le avisa al jugador que tiene que esperar que inicie la partida

                window.alert("Espere que inicie la partida");
            }
            else if((data.data+"")[0]=="1"){    //Avisa al usuario que el nombre esta en uso y vuelve a activar el boton y el campo de nombre de usuario

                window.alert(`El nombre de usuario ${user} ya esta en uso`);
                username.disabled = false;
                submit.disabled = false;     
            }
            else if ((data.data+"")[0]=="2"){   //Recibe la palabra, indica el inicio de la partida, si no es la primera partida reinicia la imagen del hangman

                palabra = data.data.slice(2);
                palabraO = palabra.split('').map(letter => (general.indexOf(letter) >= 0 ? letter : " _ ")).join('');
                palabraR.innerHTML = "Adivina la palabra: "+palabraO;
                vida.innerHTML = "Vidas restantes: "+vidas;
                inicio = true;
                window.alert("La partida acaba de empezar");
                hangmanI.src = "./src/public/images/hangman-0.jpg";
            }
            else if ((data.data+"")[0]=="3"){   //Le avisa al jugador que es su turno y desbloquea los botones de las letras

                if(vidas!=0 && inicio==true){

                    window.alert("Es tu turno");
                    for (i=0; i<botones.length; i++) botones[i].disabled = false;
                    if(botonesUsados[0]!==null) for(i=0; i<botonesUsados.length; i++) botonesUsados[i].disabled = true;
                }
            }
            else if ((data.data+"")[0]=="4"){   //Avisa de quien es el turno actual

                if (inicio == true) window.alert(`Es el turno de ${data.data.slice(2)}`);
            }
            else if ((data.data+"")[0]=="5"){   //Avisa si otro jugador gano la partida, bloquea los botones y vacia la lista de botones usados

                window.alert(`El jugador ${data.data.slice(2)} gano la partida, espera al anfitrion`);
                for (i=0; i<botones.length; i++) botones[i].disabled = true;
                botonesUsados = [];
            }
            else if ((data.data+"")[0]=="6"){   //Si completa el registro y ya hay una partida en curso le avisa que tiene que esperar a que la misma termine

                window.alert("Ya hay una partida en curso, espere que inicie una nueva partida");
                for (i=0; i<botones.length; i++) botones[i].disabled = true;
            }
            else if ((data.data+"")[0]=="7"){   //Interrumpe el registro porque el anfitrion esta ausente

                window.alert("El anfitrion no se encuentra conectado, intente de nuevo mas tarde");
                username.disabled = false;
                submit.disabled = false;
            }
            else if ((data.data+"")[0]=="8"){   //Avisa al jugador que debe reiniciar la pagina porque se perdio comunicacion con el anfitrion

                window.alert("El anfitrion se desconecto, recargue la pagina por favor");
                username.disabled = false;
                submit.disabled = false;
            }
            else if(data.data[data.data.length-1]=="s"){    //Recibe un mensaje en formato [q, ,n,o,m,b,r,e, ,s] en respuesta a la letra enviada, en este caso la respuesta fue positiva
                                                            //q puede ser cualquiera de las letras, en este caso hace referencia a la anteriormente enviada por el jugador 
                for(i=0, j=1; i<palabra.length; i++, j=j+3){

                    if((palabra+"")[i]==(data.data+"")[0]){ //Remplaza los "_" por la letra recibida en el o los lugares indicados

                        if(j+1!=palabraO.length){
                            
                            palabraO = palabraO.slice(0,j)+(data.data+"")[0]+palabraO.slice(j+1);
                        }
                        else{

                            palabraO = palabraO.slice(0,j)+(data.data+"")[0];
                        }
                    }
                }
                palabraR.innerHTML = "Adivina la palabra: "+palabraO;
                if (palabraO.indexOf("_")==-1){     //Revisa si quedan "_" en la palabra a adivinar, si ya no quedan el jugador gano la partida y  se prepara para la siguiente

                    inicio = false;
                    window.alert("Felicidades, ganaste la partida");
                    ws.send("3 "+user);
                    for (i=0; i<botones.length; i++) botones[i].disabled = true;
                    vidas = 6;
                }
            }
            else if(data.data[data.data.length-1]=="n"){    //Recibe un mensaje en formato [q, ,n,o,m,b,r,e, ,n] en respuesta a la letra enviada, en este caso la respuesta fue negativa

                vidas--;
                switch (vidas) {    //Dependiendo de la cantidad de vidas actuales se colocara una imagen del hangman

                    case 5: hangmanI.src = "./src/public/images/hangman-1.jpg";

                        break;

                    case 4: hangmanI.src = "./src/public/images/hangman-2.jpg";

                        break;
                    
                    case 3: hangmanI.src = "./src/public/images/hangman-3.jpg";

                        break;
                    
                    case 2: hangmanI.src = "./src/public/images/hangman-4.jpg";

                        break;

                    case 1: hangmanI.src = "./src/public/images/hangman-5.jpg";

                        break;

                    case 0: hangmanI.src = "./src/public/images/hangman-6.jpg";

                        break;

                    default:

                        break;
                }
                vida.innerHTML = `Vidas restantes: ${vidas}`;
                if (vidas == 0){    //Si las vidas llegan a 0 se le informa al servidor, se bloquean los botones y se prepara la siguiente partida

                    ws.send("4 "+user);
                    for (i=0; i<botones.length; i++) botones[i].disabled = true;
                    window.alert("Perdiste, espera a que la partida termine");
                    botonesUsados = [];
                    vidas = 6;
                    inicio = false;
                }
            }
        })
    })

</script>

<html>
    <head>
        <title>El ahorcado</title>
    </head>
    <body class="container">

        <div class="nombre-usuario">

            <label for="username">Nombre de usuario: </label>
            <input id="username" cols="10" rows="1"></input>
            <button id = "submit">Submit</button>
        </div>
        <div class="hangman">
            
            <img id = "hangmanI" src="./src/public/images/hangman-0.jpg" width = 298px height = 291px>
        </div>
        <div class="palabra" >

            <p id = "palabraR">Adivina la palabra:</p>
        </div>
        <div>

            <div class = "primeras-letras">

                <button id = "q" value = "q" disabled = true >q</button>
                <button id = "w" value = "w" disabled = true >w</button>
                <button id = "e" value = "e" disabled = true >e</button>
                <button id = "r" value = "r" disabled = true >r</button>
                <button id = "t" value = "t" disabled = true >t</button>
                <button id = "y" value = "y" disabled = true >y</button>
                <button id = "u" value = "u" disabled = true >u</button>
                <button id = "botonI" value = "i" disabled = true >i</button>
                <button id = "o" value = "o" disabled = true >o</button>
                <button id = "p" value = "p" disabled = true >p</button>
            </div>
            <div class = "segundas-letras">

                <button id = "a" value = "a" disabled = true >a</button>
                <button id = "s" value = "s" disabled = true >s</button>
                <button id = "d" value = "d" disabled = true >d</button>
                <button id = "f" value = "f" disabled = true >f</button>
                <button id = "g" value = "g" disabled = true >g</button>
                <button id = "h" value = "h" disabled = true >h</button>
                <button id = "j" value = "j" disabled = true >j</button>
                <button id = "k" value = "k" disabled = true >k</button>
                <button id = "l" value = "l" disabled = true >l</button>
            </div>
            <div class = "terceras-letras">

                <button id = "z" value = "z" disabled = true >z</button>
                <button id = "x" value = "x" disabled = true >x</button>
                <button id = "c" value = "c" disabled = true >c</button>
                <button id = "v" value = "v" disabled = true >v</button>
                <button id = "b" value = "b" disabled = true >b</button>
                <button id = "n" value = "n" disabled = true >n</button>
                <button id = "m" value = "m" disabled = true >m</button>
            </div>
        </div>
        <div class = "vidas-restantes">

            <p id = "vida">Vidas restantes: </p>
        </div>
    </body>
</html>

<style>

    button [id = q],[id = w],[id = e],[id = r],[id = t],[id = y],[id = u],[id = botonI],[id = o],[id = p],
    [id = a],[id = s],[id = d],[id = f],[id = g],[id = h],[id = j],[id = k],[id = l],
    [id = z],[id = x],[id = c],[id = v],[id = b],[id = n],[id = m],[id = q] {

        width: 30px;
        height: 30px;
        border-style: solid;
        border-radius: 10%;
    }

    button [id = submit] {

        width: 50px;
        height: 65px;
    }

    body{

        background-color: gray;
        color : white;
    }

    .hangman{

        position: relative;
        text-align: center;
        top: 50px;
    }

    .palabra{

        position: relative;
        text-align: center;
        top: 50px;
        font-size: 20px;
    }

    .nombre-usuario{

        position: relative;
        top: 10px;
        left: 10px;
        font-size: 20px;
    }

    .primeras-letras{

        position: relative;
        text-align: center;
        top: 50px;
    }

    .segundas-letras{

        position: relative;
        text-align: center;
        top: 55px;
    }

    .terceras-letras{

        position: relative;
        text-align: center;
        top: 60px;
    }

    .vidas-restantes{

        position: absolute;
        top: 5px;
        right: 60px;
        font-size: 20px;
    }

</style>